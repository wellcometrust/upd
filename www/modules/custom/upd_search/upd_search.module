<?php

/**
 * @file
 * UPD search module file.
 */

/**
 * Implements hook_preprocess_views_view.
 */
function upd_search_preprocess_views_view(&$variables) {
  // Hacky way of injecting an "excerpt" into view result.
  // Search API does not allow it to be added for entity
  // rendering, nor without a query string.
  $view = $variables['view'];
  if (!in_array($view->id(), ['search', 'case_studies_index'])) {
    return;
  }
  $excerpt = [];
  foreach ($view->result as $result) {
    $excerpt[$result->search_api_id] = !empty($result->search_api_excerpt) ? $result->search_api_excerpt : 'toto';
  }
  foreach ($variables['rows'] as $row) {
    foreach ($row['#rows'] as $item) {
      $id = 'entity:node/' . $item['#node']->id() . ':en';
      $item['#node']->excerpt = !empty($excerpt[$id]) ? $excerpt[$id] : '';
    }
  }
}
