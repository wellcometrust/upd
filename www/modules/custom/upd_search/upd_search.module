<?php

use Drupal\Core\Block\BlockPluginInterface;

/**
 * @file
 * UPD search module file.
 */
use Drupal\node\Entity\Node;
use Drupal\Component\Utility\Unicode;

/**
 * Retrieve a default node excerpt when none is generated from search.
 *
 * @param \Drupal\node\Entity\Node $node
 *   The loaded node entity to generate an excerpt for.
 *
 * @return string
 *   The generated excerpt, or an empty string.
 */
function upd_search_node_generate_excerpt(Node $node) {
  $excerpt = '';
  // Fetch from node if possible.
  if (isset($node->field_list_text)) {
    $excerpt = $node->get('field_list_text')->getString();
  }
  elseif (empty($excerpt) && isset($node->field_standfirst)) {
    $excerpt = $node->get('field_standfirst')->value;
  }
  // Worst case, brute force the first bit of the body.
  elseif (empty($excerpt) && isset($node->body)) {
    $excerpt = Unicode::truncate(strip_tags($node->get('body')->value), 400, TRUE, TRUE);
  }

  return Unicode::truncate($excerpt, 4000, TRUE, TRUE);
}

/**
 * Implements hook_preprocess_views_view().
 */
function upd_search_preprocess_views_view(&$variables) {
  // Hacky way of injecting an "excerpt" into view result.
  // Search API does not allow it to be added for entity
  // rendering, nor without a query string.
  // @todo If excerpt functionality is not re-instated
  // later, this whole module can be removed, and
  // the list text/standfirst can just be dealy with in
  // the template file for the listing/search view mode.
  $view = $variables['view'];
  if (!in_array($view->id(), ['search', 'case_studies_index', 'site_search'])) {
    return;
  }
//  $excerpt = [];
//  foreach ($view->result as $result) {
//    $excerpt[$result->search_api_id] = !empty($result->search_api_excerpt) ? $result->search_api_excerpt : '';
//  }
  foreach ($variables['rows'] as $row) {
    foreach ($row['#rows'] as $item) {
      //$id = 'entity:node/' . $item['#node']->id() . ':en';
      //$item['#node']->excerpt = !empty($excerpt[$id]) ? $excerpt[$id] : upd_search_node_generate_excerpt($item['#node']);
      $item['#node']->excerpt = upd_search_node_generate_excerpt($item['#node']);
    }
  }
}

/**
 * Implements hook_block_view_alter().
 *
 * NOTE: You MUST implement this hook if you want your block plugins to work
 * even if you do nothing inside the function body!
 */
function upd_search_block_view_alter(array &$build, BlockPluginInterface $block) {
}

/**
 * Implements hook_preprocess_block().
 *
 */
function upd_search_preprocess_block(&$variables) {
  // Hide some content types in the facet.
  $content_type_to_hide = ['FAQ', 'Tile'];
  if ($variables['elements']['#plugin_id'] == 'facet_block:content_type_solr') {
    foreach ($variables['content'][0]['#items'] as $i => $facet) {
      if (in_array($facet['#title']['#value'], $content_type_to_hide)) {
        unset($variables['content'][0]['#items'][$i]);
      }
    }
  }
}