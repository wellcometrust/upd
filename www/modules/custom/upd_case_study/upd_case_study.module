<?php

/**
 * @file
 */

use Drupal\Core\Block\BlockPluginInterface;
use Drupal\Core\Entity\EntityTypeBundleManagerInterface;

/**
 * @file
 * UPD case study module file.
 */

/**
 * Implements hook_block_view_alter().
 *
 * NOTE: You MUST implement this hook if you want your block plugins to work
 * even if you do nothing inside the function body!
 */
function upd_case_study_block_view_alter(array &$build, BlockPluginInterface $block) {

}

/**
 * Implements hook_preprocess_node().
 */
function upd_case_study_preprocess_node(&$variables) {
  _upd_case_study_preprocess_node_vertical_tabs($variables);
  _upd_case_study_preprocess_node_tags($variables);
  _upd_case_study_preprocess_node_nextprevious($variables);
}

/**
 * Alter node rendering to add pseudo "vertical tabs".
 *
 * @see upd_preprocess_node()
 */
function _upd_case_study_preprocess_node_vertical_tabs(&$variables) {
  if ($variables['view_mode'] !== 'full') {
    return;
  }
  $node = $variables['node'];
  if (!isset($node->field_vertical_tab)) {
    return;
  }
  $i = 0;
  $variables['content']['vertical'][$i]['title'] = 'Summary';
  $variables['content']['vertical'][$i]['url'] = 'intro';
  foreach ($node->field_vertical_tab as $item) {
    $i++;
    $variables['content']['vertical'][$i]['title'] = $item->entity->get('field_title')->getValue()[0]['value'];
    $variables['content']['vertical'][$i]['url'] = strtolower(trim(preg_replace('/[^A-Za-z0-9-]+/', '-', $item->entity->get('field_title')->getValue()[0]['value'])));
  }
}

/**
 * Gather all taxonomy fields into a single place for theming.
 *
 * @see upd_preprocess_node()
 */
function _upd_case_study_preprocess_node_tags(&$variables) {
  $node = $variables['node'];
  if ($node->bundle() !== 'case_study') {
    return;
  }
  $fields = [
    'field_impact_of_work',
  ];
  foreach ($fields as $field) {
    foreach ($node->get($field)->referencedEntities() as $term) {
      $color = $term->get('field_color')->value;
      $node->updTags[$term->id()] = [
        'label' => $term->label(),
        'color' => !empty($color) ? $color : 'f8533d',
      ];
    }
  }
}

/**
 * Getting nextpreviousblock and pass it to template.
 *
 * @see upd_preprocess_node()
 */
function _upd_case_study_preprocess_node_nextprevious(&$variables) {
  if ($variables['node']->getType() != 'case_study') {
    return;
  }
  $nextprevious_block = \Drupal::entityManager()->getStorage('block')->load('nextpreviousblock');
  if (!empty($nextprevious_block)) {
    $nextprevious_block_content = \Drupal::entityManager()
      ->getViewBuilder('block')
      ->view($nextprevious_block);
    if ($nextprevious_block_content) {
      $variables['content']['nextpreviousblock'] = $nextprevious_block_content;
    }
  }
}

/**
 * Implements hook_preprocess_paragraph().
 *
 */
function upd_case_study_preprocess_paragraph(&$variables) {

  $paragraph_bundle = $variables['paragraph']->bundle();

  switch ($paragraph_bundle) {
    case 'basic_vertical_tab':
    case 'case_study_vertical_tab':
    case 'faq_dropdowns':

      if (!empty($variables['content']['field_title'][0]['#context']['value'])) {
        $variables['content']['paragraph_url'] = strtolower(trim(preg_replace('/[^A-Za-z0-9-]+/', '-', $variables['content']['field_title'][0]['#context']['value'])));
      }

      break;
  }

}

/**
 * Implements hook_preprocess_field().
 */
function upd_case_study_preprocess_field(&$variables, $hook) {
  if ($variables['field_name'] != 'field_thumbnail') {
    return;
  }
  if ($variables['entity_type'] !== 'node') {
    return;
  }
  $class = 'case-study-tile__image';
  foreach ($variables['items'] as $delta => $item) {
    $variables['items'][$delta]['content']['#item_attributes']['class'][] = $class;
  }
}
